<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Nachbarschaftssteckbrief</title>
  <style>
    body { 
      font-family: Arial; 
      padding: 20px; 
      max-width: 700px; 
      margin: auto; 
      background: #e9e9ff;
    }
    .form-box {
      background: #ffffff;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
    }
    h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    h2 {
      font-size: 18px;
      margin-top: 25px;
      margin-bottom: 5px;
    }
    p.sub {
      margin-top: 0;
      color: #555;
      font-size: 14px;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    label span.req {
      color: red;
    }
    input, textarea, select {
      width: 100%;
      padding: 8px 10px;
      margin-top: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }
    textarea {
      min-height: 80px;
    }
    button {
      margin-top: 20px;
      padding: 12px 20px;
      font-size: 18px;
      cursor: pointer;
    }
    .error-text {
      color: red;
      font-size: 13px;
      margin-top: 4px;
      display: none;
    }
  </style>
</head>
<body>

<div class="form-box">
  <h1>Nachbarschaftssteckbrief</h1>
  <p class="sub">DRK Ortsverein Bahlingen e.V.</p>

  <form id="myForm">
    <!-- Mitgliedsart -->
    <label for="mitgliedsart">Mitgliedsart <span class="req">*</span></label>
    <select id="mitgliedsart" required>
      <option value="">Bitte wählen</option>
      <option value="NMG">NMG</option>
      <option value="ERH">ERH</option>
    </select>

    <!-- Vor- und Nachname -->
    <label for="vorname">Vorname <span class="req">*</span></label>
    <input type="text" id="vorname" required>

    <label for="nachname">Nachname <span class="req">*</span></label>
    <input type="text" id="nachname" required>

    <!-- Geburtsdatum -->
    <label for="geburtsdatum">Geburtsdatum</label>
    <input type="date" id="geburtsdatum">

    <!-- E-Mail -->
    <label for="email">E-Mail <span class="req">*</span></label>
    <input type="email" id="email" required>

    <!-- Telefon mobil -->
    <label for="telefon">Telefon (mobil)</label>
    <input type="text" id="telefon" placeholder="+49 ...">

    <!-- Straße und Hausnummer -->
    <h2>Adresse</h2>

    <label for="strasse">Straße und Hausnummer</label>
    <input type="text" id="strasse" placeholder="z.B. Musterstraße 1">

    <!-- PLZ / Ort -->
    <label for="plz">PLZ</label>
    <input type="text" id="plz" placeholder="z.B. 79353">

    <label for="ort">Ort</label>
    <input type="text" id="ort" placeholder="z.B. Bahlingen">

    <!-- IBAN -->
    <h2>Zahlungsinformationen</h2>

    <label for="iban">IBAN <span class="req">*</span></label>
    <input 
      type="text" 
      id="iban" 
      placeholder="z.B. DE12 3456 7890 1234 5678 90" 
      required
    >
    <div id="ibanError" class="error-text">Die IBAN ist ungültig.</div>

    <!-- Freitext / Hinweise -->
    <label for="hinweise">Hinweise / Nachricht</label>
    <textarea id="hinweise" placeholder="Optionale Hinweise"></textarea>

    <button type="submit">Absenden</button>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // Supabase Client aktivieren
  const db = supabase.createClient(
    "https://ipitjuyeplkaywatmnxg.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwaXRqdXllcGxrYXl3YXRtbnhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTU3NjEsImV4cCI6MjA3ODYzMTc2MX0.JZ71lI049-_Z0bJvXIyIOoMFNR_Cgg7wLgbuOEsXCec"
  );

  const form = document.getElementById("myForm");
  const ibanField = document.getElementById("iban");
  const ibanError = document.getElementById("ibanError");

  // IBAN "sauber" machen: Leerzeichen raus, groß schreiben
  function cleanIban(value) {
    return value.replace(/\s+/g, "").toUpperCase();
  }

  // IBAN für Anzeige formatieren: DE09 0000 0000 ...
  function formatIbanDisplay(value) {
    const clean = cleanIban(value);
    // in 4er-Gruppen mit Leerzeichen
    return clean.replace(/(.{4})/g, "$1 ").trim();
  }

  // Prüfzifferberechnung nach IBAN-Standard (MOD 97)
  function isValidIban(iban) {
    const clean = cleanIban(iban);
    // grobe Mindestlänge prüfen
    if (clean.length < 15) return false;

    // Erste 4 Zeichen nach hinten
    const rearranged = clean.slice(4) + clean.slice(0, 4);

    // Buchstaben in Zahlen umwandeln (A=10 ... Z=35)
    let numeric = "";
    for (let i = 0; i < rearranged.length; i++) {
      const char = rearranged[i];
      if (char >= "A" && char <= "Z") {
        numeric += (char.charCodeAt(0) - 55).toString(); // A(65) -> 10
      } else if (char >= "0" && char <= "9") {
        numeric += char;
      } else {
        return false; // ungültiges Zeichen
      }
    }

    // Modulo 97 iterativ berechnen
    let remainder = 0;
    for (let i = 0; i < numeric.length; i++) {
      const digit = parseInt(numeric[i], 10);
      if (isNaN(digit)) return false;
      remainder = (remainder * 10 + digit) % 97;
    }
    // gültige IBAN: Rest = 1
    return remainder === 1;
  }

  // Live-Formatierung + Live-Check
  function handleIbanInput() {
    const clean = cleanIban(ibanField.value);
    ibanField.value = formatIbanDisplay(clean);

    if (clean === "") {
      ibanError.style.display = "none";
      return;
    }

    if (!isValidIban(clean)) {
      ibanError.style.display = "block";
    } else {
      ibanError.style.display = "none";
    }
  }

  ibanField.addEventListener("input", handleIbanInput);
  ibanField.addEventListener("blur", handleIbanInput);

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const ibanClean = cleanIban(ibanField.value);

    // Vor dem Speichern endgültig prüfen
    if (!isValidIban(ibanClean)) {
      ibanError.style.display = "block";
      ibanField.focus();
      return; // Formular nicht abschicken
    }

    // FELDER AUSLESEN
    const data = {
      // alte Spalten feld1..feld10 weiterverwenden,
      // nur mit neuen Bedeutungen:
      feld1: document.getElementById("mitgliedsart").value,  // Mitgliedsart
      feld2: document.getElementById("vorname").value,       // Vorname
      feld3: document.getElementById("nachname").value,      // Nachname
      feld4: document.getElementById("email").value,         // E-Mail
      feld5: document.getElementById("telefon").value,       // Telefon mobil
      feld6: document.getElementById("strasse").value,       // Straße+Nr.
      feld7: document.getElementById("plz").value,           // PLZ
      feld8: document.getElementById("ort").value,           // Ort
      feld9: document.getElementById("geburtsdatum").value,  // Geburtsdatum
      feld10: document.getElementById("hinweise").value,     // Hinweise
      // NEUES FELD IN TABELLE: IBAN ohne Leerzeichen
      iban: ibanClean
    };

    // IN SUPABASE SPEICHERN
    const { error } = await db
      .from("formular")
      .insert([data]);

    if (error) {
      alert("Fehler beim Speichern: " + error.message);
      console.error(error);
    } else {
      alert("Erfolgreich gespeichert!");
      form.reset();
      ibanError.style.display = "none";
    }
  });

  // Enter in normalen Feldern blocken (außer Textarea)
  form.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && e.target.tagName !== "TEXTAREA") {
      e.preventDefault();
    }
  });
</script>

</body>
</html>
