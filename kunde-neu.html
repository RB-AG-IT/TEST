<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Neuer Kunde</title>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 600px; margin: auto; }
    input, textarea { width: 100%; padding: 8px; margin: 5px 0; }
    button { padding: 8px 16px; margin-top: 10px; cursor: pointer; }
    a { display: inline-block; margin-top: 15px; }
  </style>
</head>
<body>
  <h2>Neuen Kunden anlegen</h2>

  <form id="kundenForm">
    <input id="vorname"  placeholder="Vorname" required>
    <input id="nachname" placeholder="Nachname" required>
    <input id="email"    type="email" placeholder="E-Mail">
    <input id="telefon"  placeholder="Telefon">
    <input id="kunde"    placeholder="Kundenname / Firma">
    <input id="strasse"  placeholder="Straße">
    <input id="stadt"    placeholder="Stadt">
    <!-- NEU: Bild-Upload -->
    <input id="bild" type="file" accept="image/*">
    <textarea id="bemerkung" placeholder="Bemerkung"></textarea>
    <button type="submit">Speichern</button>
  </form>

  <a href="index.html">Zurück zur Startseite</a>
  <a href="kunden-liste.html">Zur Kundenliste</a>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const db = supabase.createClient(
      "https://ipitjuyeplkaywatmnxg.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwaXRqdXllcGxrYXl3YXRtbnhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTU3NjEsImV4cCI6MjA3ODYzMTc2MX0.JZ71lI049-_Z0bJvXIyIOoMFNR_Cgg7wLgbuOEsXCec"
    );

    const form = document.getElementById("kundenForm");

    // Enter in Inputs blocken (außer Textarea)
    form.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && e.target.tagName !== "TEXTAREA") {
        e.preventDefault();
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // 1) Bild hochladen (falls vorhanden)
      const fileInput = document.getElementById("bild");
      let bild_url = null;

      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const fileName = `${Date.now()}_${file.name}`;

        const { data: uploadData, error: uploadError } = await db
          .storage
          .from("kunden-bilder")   // Bucket-Name
          .upload(fileName, file);

        if (uploadError) {
          alert("Fehler beim Bildupload: " + uploadError.message);
          console.error(uploadError);
        } else {
          const { data: publicUrlData } = db
            .storage
            .from("kunden-bilder")
            .getPublicUrl(fileName);

          bild_url = publicUrlData.publicUrl;
        }
      }

      // 2) Kunde in Tabelle speichern
      const kunde = {
        vorname:  document.getElementById("vorname").value,
        nachname: document.getElementById("nachname").value,
        email:    document.getElementById("email").value,
        telefon:  document.getElementById("telefon").value,
        kunde:    document.getElementById("kunde").value,
        strasse:  document.getElementById("strasse").value,
        stadt:    document.getElementById("stadt").value,
        bemerkung:document.getElementById("bemerkung").value,
        bild_url: bild_url // NEU
      };

      const { error } = await db.from("kunden").insert([kunde]);

      if (error) {
        alert("Fehler: " + error.message);
        console.error(error);
        return;
      }

      alert("Kunde gespeichert");
      form.reset();
    });
  </script>
</body>
</html>
