<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Nachbarschaftssteckbrief</title>
  <style>
    body { 
      font-family: Arial; 
      padding: 20px; 
      max-width: 700px; 
      margin: auto; 
      background: #e9e9ff;
    }
    .form-box {
      background: #ffffff;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
    }
    h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    h2 {
      font-size: 18px;
      margin-top: 25px;
      margin-bottom: 5px;
    }
    p.sub {
      margin-top: 0;
      color: #555;
      font-size: 14px;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    label span.req {
      color: red;
    }
    input, textarea, select {
      width: 100%;
      padding: 8px 10px;
      margin-top: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }
    textarea {
      min-height: 80px;
    }
    button {
      margin-top: 20px;
      padding: 12px 20px;
      font-size: 18px;
      cursor: pointer;
    }
    .error-text {
      color: red;
      font-size: 13px;
      margin-top: 4px;
      display: none;
    }

    /* Autocomplete Styles */
    .autocomplete-list {
      position: absolute;
      left: 0;
      right: 0;
      background: #ffffff;
      border: 1px solid #ccc;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      font-size: 14px;
    }

    .autocomplete-list .item {
      padding: 6px 8px;
      cursor: pointer;
    }

    .autocomplete-list .item:hover {
      background: #eee;
    }
  </style>
</head>
<body>

<div class="form-box">
  <h1>Nachbarschaftssteckbrief</h1>
  <p class="sub">DRK Ortsverein Bahlingen e.V.</p>

  <form id="myForm">
    <!-- Mitgliedsart -->
    <label for="mitgliedsart">Mitgliedsart <span class="req">*</span></label>
    <select id="mitgliedsart" required>
      <option value="">Bitte wählen</option>
      <option value="NMG">NMG</option>
      <option value="ERH">ERH</option>
    </select>

    <!-- Vor- und Nachname -->
    <label for="vorname">Vorname <span class="req">*</span></label>
    <input type="text" id="vorname" required>

    <label for="nachname">Nachname <span class="req">*</span></label>
    <input type="text" id="nachname" required>

    <!-- Geburtsdatum -->
    <label for="geburtsdatum">Geburtsdatum</label>
    <input type="date" id="geburtsdatum">

    <!-- E-Mail -->
    <label for="email">E-Mail <span class="req">*</span></label>
    <input type="email" id="email" required>

    <!-- Telefon mobil -->
    <label for="telefon">Telefon (mobil)</label>
    <input type="text" id="telefon" placeholder="+49 ...">

    <!-- Adresse -->
    <h2>Adresse</h2>

    <label for="strasse">Straße und Hausnummer</label>
    <input type="text" id="strasse" placeholder="z.B. Musterstraße 1">

    <label for="plz">PLZ</label>
    <input type="text" id="plz" placeholder="z.B. 79353">

    <label for="ort">Ort</label>
    <input type="text" id="ort" placeholder="z.B. Bahlingen">

    <!-- IBAN -->
    <h2>Zahlungsinformationen</h2>

    <label for="iban">IBAN <span class="req">*</span></label>
    <input 
      type="text" 
      id="iban" 
      placeholder="z.B. DE89 3704 0044 0532 0130 00" 
      required
    >
    <div id="ibanError" class="error-text">Die IBAN ist ungültig.</div>

    <!-- Freitext / Hinweise -->
    <label for="hinweise">Hinweise / Nachricht</label>
    <textarea id="hinweise" placeholder="Optionale Hinweise"></textarea>

    <button type="submit">Absenden</button>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // Supabase Client aktivieren
  const db = supabase.createClient(
    "https://ipitjuyeplkaywatmnxg.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwaXRqdXllcGxrYXl3YXRtbnhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTU3NjEsImV4cCI6MjA3ODYzMTc2MX0.JZ71lI049-_Z0bJvXIyIOoMFNR_Cgg7wLgbuOEsXCec"
  );

  const form = document.getElementById("myForm");
  const ibanField = document.getElementById("iban");
  const ibanError = document.getElementById("ibanError");

  function cleanIban(value) {
    return value.replace(/\s+/g, "").toUpperCase();
  }

  function formatIbanDisplay(value) {
    const clean = cleanIban(value);
    return clean.replace(/(.{4})/g, "$1 ").trim();
  }

  function isValidIban(iban) {
    const clean = cleanIban(iban);
    if (clean.length < 15 || clean.length > 34) return false;
    const rearranged = clean.slice(4) + clean.slice(0, 4);

    let numeric = "";
    for (let i = 0; i < rearranged.length; i++) {
      const char = rearranged[i];
      if (char >= "A" && char <= "Z") {
        numeric += (char.charCodeAt(0) - 55).toString();
      } else if (char >= "0" && char <= "9") {
        numeric += char;
      } else {
        return false;
      }
    }

    let remainder = 0;
    for (let i = 0; i < numeric.length; i++) {
      const digit = parseInt(numeric[i], 10);
      if (isNaN(digit)) return false;
      remainder = (remainder * 10 + digit) % 97;
    }
    return remainder === 1;
  }

  function handleIbanInput() {
    const clean = cleanIban(ibanField.value);
    ibanField.value = formatIbanDisplay(clean);

    if (clean.length < 15) {
      ibanError.style.display = "none";
      return;
    }

    ibanError.style.display = isValidIban(clean) ? "none" : "block";
  }

  ibanField.addEventListener("input", handleIbanInput);
  ibanField.addEventListener("blur", handleIbanInput);

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const ibanClean = cleanIban(ibanField.value);
    if (!isValidIban(ibanClean)) {
      ibanError.style.display = "block";
      ibanField.focus();
      return;
    }

    const data = {
      feld1: document.getElementById("mitgliedsart").value,
      feld2: document.getElementById("vorname").value,
      feld3: document.getElementById("nachname").value,
      feld4: document.getElementById("email").value,
      feld5: document.getElementById("telefon").value,
      feld6: document.getElementById("strasse").value,
      feld7: document.getElementById("plz").value,
      feld8: document.getElementById("ort").value,
      feld9: document.getElementById("geburtsdatum").value,
      feld10: document.getElementById("hinweise").value,
      iban: ibanClean
    };

    const { error } = await db.from("formular").insert([data]);

    if (error) {
      alert("Fehler beim Speichern: " + error.message);
    } else {
      alert("Erfolgreich gespeichert!");
      form.reset();
      ibanError.style.display = "none";
    }
  });

  form.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && e.target.tagName !== "TEXTAREA") {
      e.preventDefault();
    }
  });
</script>

<!-- GEOAPIFY AUTOCOMPLETE -->
<script>
  const GEOAPIFY_KEY = "bbb56e4d3e5447a89b834ac1c3b8875d";

  const strasseInput = document.getElementById("strasse");
  const plzInput = document.getElementById("plz");
  const ortInput = document.getElementById("ort");

  const box = document.createElement("div");
  box.className = "autocomplete-list";
  strasseInput.parentNode.insertBefore(box, strasseInput.nextSibling);

  let lastController = null;

  strasseInput.addEventListener("input", () => {
    const text = strasseInput.value.trim();
    if (text.length < 3) {
      box.style.display = "none";
      return;
    }

    if (lastController) lastController.abort();
    lastController = new AbortController();

    const url =
      "https://api.geoapify.com/v1/geocode/autocomplete?text=" +
      encodeURIComponent(text) +
      "&filter=countrycode:de&format=json&apiKey=" + GEOAPIFY_KEY;

    fetch(url, { signal: lastController.signal })
      .then(r => r.json())
      .then(data => {
        const results = data.results || [];
        if (!results.length) {
          box.style.display = "none";
          return;
        }

        box.innerHTML = results.slice(0, 5).map(r => `
          <div class="item"
            data-street="${r.street || ""}"
            data-housenumber="${r.housenumber || ""}"
            data-postcode="${r.postcode || ""}"
            data-city="${r.city || ""}">
            ${r.street || ""} ${r.housenumber || ""}, ${r.postcode || ""} ${r.city || ""}
          </div>`
        ).join("");

        box.style.display = "block";
      })
      .catch(err => {
        if (err.name !== "AbortError") console.error(err);
      });
  });

  box.addEventListener("click", (e) => {
    const item = e.target.closest(".item");
    if (!item) return;

    strasseInput.value = `${item.dataset.street} ${item.dataset.housenumber}`.trim();
    plzInput.value = item.dataset.postcode;
    ortInput.value = item.dataset.city;

    box.style.display = "none";
  });

  document.addEventListener("click", (e) => {
    if (!e.target.closest(".autocomplete-list") &&
        e.target !== strasseInput) {
      box.style.display = "none";
    }
  });
</script>

</body>
</html>
